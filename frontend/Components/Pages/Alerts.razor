@page "/alerts"
@inject HttpClient Http
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Alerts - SIMS</PageTitle>

<div class="page-wrapper">
    <div class="page-header">
        <h1>ðŸ”” Alerts Management</h1>
    </div>

    <!-- Filters -->
    <div class="filters-card">
        <div class="filter-group">
            <label>Severity</label>
            <select @bind="filterSeverity" @bind:event="onchange" class="filter-select">
                <option value="">All</option>
                <option value="Critical">Critical</option>
                <option value="High">High</option>
                <option value="Medium">Medium</option>
                <option value="Low">Low</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Status</label>
            <select @bind="filterStatus" @bind:event="onchange" class="filter-select">
                <option value="">All</option>
                <option value="New">New</option>
                <option value="Acknowledged">Acknowledged</option>
                <option value="Resolved">Resolved</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Date From</label>
            <input type="date" @bind="filterDateFrom" @bind:event="onchange" class="filter-input" />
        </div>
        <div class="filter-group">
            <label>Date To</label>
            <input type="date" @bind="filterDateTo" @bind:event="onchange" class="filter-input" />
        </div>
        <button class="btn-reset" @onclick="ResetFilters">Reset</button>
    </div>

    <!-- Alerts Table -->
    <div class="content-card">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Alert ID</th>
                    <th>Description</th>
                    <th>Host</th>
                    <th>Severity</th>
                    <th>Status</th>
                    <th>Timestamp</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (filteredAlerts == null)
                {
                    <tr><td colspan="7" class="loading">Loading...</td></tr>
                }
                else if (!filteredAlerts.Any())
                {
                    <tr><td colspan="7" class="no-data">No alerts found</td></tr>
                }
                else
                {
                    @foreach (var alert in filteredAlerts)
                    {
                        <tr class="table-row">
                            <td class="alert-id">@alert.AlertId</td>
                            <td>@alert.Description</td>
                            <td>@alert.Host</td>
                            <td>
                                <span class="severity-badge severity-@alert.Severity.ToLower()">
                                    @alert.Severity
                                </span>
                            </td>
                            <td>@alert.Status</td>
                            <td>@alert.Timestamp.ToString("dd.MM.yyyy HH:mm")</td>
                            <td>
                                <button class="btn-convert" @onclick="() => ConvertToIncident(alert.Id)">
                                    Convert to Incident
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<style>
    :root {
        --color-primary: #113B40;
        --color-success: #038C3E;
        --color-bg: #F2F2F2;
        --color-white: #FFFFFF;
        --severity-critical: #E3342F;
        --severity-high: #3B82F6;
        --severity-medium: #FACC15;
        --severity-low: #9CA3AF;
    }

    .page-wrapper {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
        background: var(--color-bg);
        min-height: 100vh;
    }

    .page-header {
        margin-bottom: 2rem;
    }

    .page-header h1 {
        color: var(--color-primary);
        font-size: 2rem;
    }

    .filters-card {
        background: var(--color-white);
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .filter-group label {
        font-weight: 600;
        font-size: 0.875rem;
        color: var(--color-primary);
    }

    .filter-select, .filter-input {
        padding: 0.5rem 1rem;
        border: 1px solid #E0E0E0;
        border-radius: 6px;
        font-size: 0.875rem;
    }

    .btn-reset {
        padding: 0.5rem 1.5rem;
        background: #6B7280;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
    }

    .btn-reset:hover {
        background: #4B5563;
    }

    .content-card {
        background: var(--color-white);
        border-radius: 12px;
        padding: 1.5rem;
        overflow-x: auto;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th {
        text-align: left;
        padding: 1rem;
        background: var(--color-bg);
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
    }

    .data-table td {
        padding: 1rem;
        border-bottom: 1px solid #E0E0E0;
    }

    .table-row:hover {
        background: var(--color-bg);
    }

    .alert-id {
        font-weight: 600;
        color: var(--color-primary);
    }

    .severity-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
    }

    .severity-critical {
        background: #FEE2E2;
        color: var(--severity-critical);
    }

    .severity-high {
        background: #DBEAFE;
        color: var(--severity-high);
    }

    .severity-medium {
        background: #FEF3C7;
        color: #92400E;
    }

    .severity-low {
        background: #F3F4F6;
        color: var(--severity-low);
    }

    .btn-convert {
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, var(--color-success) 0%, #41BF78 100%);
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-convert:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(3, 140, 62, 0.3);
    }

    .loading, .no-data {
        text-align: center;
        padding: 3rem;
        color: #6B7280;
    }
</style>

@code {
    private List<AlertDto>? alerts;
    private List<AlertDto>? filteredAlerts;
    
    private string _filterSeverity = "";
    private string filterSeverity 
    { 
        get => _filterSeverity; 
        set { _filterSeverity = value; ApplyFilters(); } 
    }
    
    private string _filterStatus = "";
    private string filterStatus 
    { 
        get => _filterStatus; 
        set { _filterStatus = value; ApplyFilters(); } 
    }
    
    private DateTime? _filterDateFrom;
    private DateTime? filterDateFrom 
    { 
        get => _filterDateFrom; 
        set { _filterDateFrom = value; ApplyFilters(); } 
    }
    
    private DateTime? _filterDateTo;
    private DateTime? filterDateTo 
    { 
        get => _filterDateTo; 
        set { _filterDateTo = value; ApplyFilters(); } 
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadAlerts();
    }

    private async Task LoadAlerts()
    {
        try
        {
            alerts = await Http.GetFromJsonAsync<List<AlertDto>>("api/alerts");
            ApplyFilters();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading alerts: {ex.Message}");
        }
    }

    private void ApplyFilters()
    {
        filteredAlerts = alerts?.Where(a =>
            (string.IsNullOrEmpty(filterSeverity) || a.Severity == filterSeverity) &&
            (string.IsNullOrEmpty(filterStatus) || a.Status == filterStatus) &&
            (!filterDateFrom.HasValue || a.Timestamp >= filterDateFrom.Value) &&
            (!filterDateTo.HasValue || a.Timestamp <= filterDateTo.Value.AddDays(1))
        ).ToList();
    }

    private void ResetFilters()
    {
        filterSeverity = "";
        filterStatus = "";
        filterDateFrom = null;
        filterDateTo = null;
        ApplyFilters();
    }

    private async Task ConvertToIncident(int alertId)
    {
        try
        {
            var response = await Http.PostAsync($"api/alerts/{alertId}/convert-to-incident", null);
            if (response.IsSuccessStatusCode)
            {
                // Reload alerts to reflect the status change
                await LoadAlerts();
                // Optionally navigate to incidents page
                // Navigation.NavigateTo("/incidents");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error converting to incident: {ex.Message}");
        }
    }

    public class AlertDto
    {
        public int Id { get; set; }
        public string AlertId { get; set; } = "";
        public string Description { get; set; } = "";
        public string Host { get; set; } = "";
        public string Severity { get; set; } = "Low";
        public string Status { get; set; } = "New";
        public DateTime Timestamp { get; set; }
        public int AlertLevel { get; set; }
    }
}
