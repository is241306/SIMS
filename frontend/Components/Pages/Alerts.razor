@page "/alerts"
@inject HttpClient Http
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Alerts - SIMS</PageTitle>

<div class="dashboard-wrapper">
    <div class="page-header">
        <h1>
            <i class="bi bi-bell-fill"></i>
            <span>Alerts Management</span>
        </h1>
    </div>

    <!-- Filters -->
    <div class="content-card filters-card">
        <div class="filters-inner">
            <div class="filter-group">
                <label>Severity</label>
                <select @bind="filterSeverity" @bind:event="onchange" class="filter-select">
                    <option value="">All</option>
                    <option value="Critical">Critical</option>
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Status</label>
                <select @bind="filterStatus" @bind:event="onchange" class="filter-select">
                    <option value="">All</option>
                    <option value="New">New</option>
                    <option value="Acknowledged">Acknowledged</option>
                    <option value="Resolved">Resolved</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Date From</label>
                <input type="date" @bind="filterDateFrom" @bind:event="onchange" class="filter-input" />
            </div>

            <div class="filter-group">
                <label>Date To</label>
                <input type="date" @bind="filterDateTo" @bind:event="onchange" class="filter-input" />
            </div>

            <div class="filters-actions">
                <button class="action-btn" @onclick="ResetFilters">
                    <i class="bi bi-arrow-counterclockwise"></i>
                    Reset
                </button>
            </div>
        </div>
    </div>

    <!-- Alerts Table -->
    <div class="content-card">
        <div class="card-header">
            <h2>Alerts</h2>
            <span class="badge-soft">
                @(filteredAlerts?.Count ?? 0) alert(s)
            </span>
        </div>

        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Alert ID</th>
                        <th>Description</th>
                        <th>Host</th>
                        <th>Severity</th>
                        <th>Status</th>
                        <th>Timestamp</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (filteredAlerts == null)
                    {
                        <tr>
                            <td colspan="7" class="loading">Loading...</td>
                        </tr>
                    }
                    else if (!filteredAlerts.Any())
                    {
                        <tr>
                            <td colspan="7" class="no-data">No alerts found</td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var alert in filteredAlerts)
                        {
                            <tr class="table-row">
                                <td class="alert-id">@alert.AlertId</td>
                                <td>@alert.Description</td>
                                <td>@alert.Host</td>
                                <td>
                                    <span class="severity-badge severity-@alert.Severity.ToLower()">
                                        @alert.Severity
                                    </span>
                                </td>
                                <td>@alert.Status</td>
                                <td>@alert.Timestamp.ToString("dd.MM.yyyy HH:mm")</td>
                                <td>
                                    <button class="btn-convert" @onclick="() => ConvertToIncident(alert.Id)">
                                        <i class="bi bi-arrow-right-circle"></i>
                                        Convert to Incident
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {
    private List<AlertDto>? alerts;
    private List<AlertDto>? filteredAlerts;
    
    private string _filterSeverity = "";
    private string filterSeverity 
    { 
        get => _filterSeverity; 
        set { _filterSeverity = value; ApplyFilters(); } 
    }
    
    private string _filterStatus = "";
    private string filterStatus 
    { 
        get => _filterStatus; 
        set { _filterStatus = value; ApplyFilters(); } 
    }
    
    private DateTime? _filterDateFrom;
    private DateTime? filterDateFrom 
    { 
        get => _filterDateFrom; 
        set { _filterDateFrom = value; ApplyFilters(); } 
    }
    
    private DateTime? _filterDateTo;
    private DateTime? filterDateTo 
    { 
        get => _filterDateTo; 
        set { _filterDateTo = value; ApplyFilters(); } 
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadAlerts();
    }

    private async Task LoadAlerts()
    {
        try
        {
            alerts = await Http.GetFromJsonAsync<List<AlertDto>>("api/alerts");
            ApplyFilters();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading alerts: {ex.Message}");
        }
    }

    private void ApplyFilters()
    {
        filteredAlerts = alerts?.Where(a =>
            (string.IsNullOrEmpty(filterSeverity) || a.Severity == filterSeverity) &&
            (string.IsNullOrEmpty(filterStatus) || a.Status == filterStatus) &&
            (!filterDateFrom.HasValue || a.Timestamp >= filterDateFrom.Value) &&
            (!filterDateTo.HasValue || a.Timestamp <= filterDateTo.Value.AddDays(1))
        ).ToList();
    }

    private void ResetFilters()
    {
        filterSeverity = "";
        filterStatus = "";
        filterDateFrom = null;
        filterDateTo = null;
        ApplyFilters();
    }

    private async Task ConvertToIncident(int alertId)
    {
        try
        {
            var response = await Http.PostAsync($"api/alerts/{alertId}/convert-to-incident", null);
            if (response.IsSuccessStatusCode)
            {
                await LoadAlerts();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error converting to incident: {ex.Message}");
        }
    }

    public class AlertDto
    {
        public int Id { get; set; }
        public string AlertId { get; set; } = "";
        public string Description { get; set; } = "";
        public string Host { get; set; } = "";
        public string Severity { get; set; } = "Low";
        public string Status { get; set; } = "New";
        public DateTime Timestamp { get; set; }
        public int AlertLevel { get; set; }
    }
}
