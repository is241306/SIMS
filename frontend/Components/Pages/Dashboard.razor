@page "/dashboard"
@inject HttpClient Http
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Dashboard - SIMS</PageTitle>

<div class="dashboard-wrapper" style="border-radius: 10px">
    <div class="dashboard-header">
        <h1>Dashboard</h1>
        <div class="header-actions">
            @{
                var tz = TimeZoneInfo.FindSystemTimeZoneById("Central European Standard Time");
                var localTime = TimeZoneInfo.ConvertTime(DateTime.UtcNow, tz);
            }
            <span class="last-update">Last updated: @localTime.ToString("HH:mm:ss")</span>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card primary">
            <div class="stat-icon"><i class="bi bi-clipboard-data"></i></div>
            <div class="stat-content">
                <div class="stat-number">@openIncidents</div>
                <div class="stat-label">Open Incidents</div>
            </div>
        </div>
        <div class="stat-card success">
            <div class="stat-icon"><i class="bi bi-bell-fill"></i></div>
            <div class="stat-content">
                <div class="stat-number">@newAlerts</div>
                <div class="stat-label">New Alerts</div>
            </div>
        </div>
        <div class="stat-card danger">
            <div class="stat-icon"><i class="bi bi-exclamation-octagon-fill"></i></div>
            <div class="stat-content">
                <div class="stat-number">@criticalCount</div>
                <div class="stat-label">Critical Issues</div>
            </div>
        </div>
        <div class="stat-card info">
            <div class="stat-icon"><i class="bi bi-check2-circle"></i></div>
            <div class="stat-content">
                <div class="stat-number">@resolvedToday</div>
                <div class="stat-label">Resolved Today</div>
            </div>
        </div>
    </div>

    <!-- Severity Distribution Chart -->
    <div class="content-card">
        <div class="card-header">
            <h2>Severity Distribution</h2>
        </div>
        <div class="severity-chart">
            <div class="chart-bar">
                <div class="bar-label">Critical</div>
                <div class="bar-wrapper">
                    <div class="bar bar-critical" style="width: @GetPercentage(criticalCount)%">
                        <span class="bar-text">@criticalCount</span>
                    </div>
                </div>
            </div>
            <div class="chart-bar">
                <div class="bar-label">High</div>
                <div class="bar-wrapper">
                    <div class="bar bar-high" style="width: @GetPercentage(highCount)%">
                        <span class="bar-text">@highCount</span>
                    </div>
                </div>
            </div>
            <div class="chart-bar">
                <div class="bar-label">Medium</div>
                <div class="bar-wrapper">
                    <div class="bar bar-medium" style="width: @GetPercentage(mediumCount)%">
                        <span class="bar-text">@mediumCount</span>
                    </div>
                </div>
            </div>
            <div class="chart-bar">
                <div class="bar-label">Low</div>
                <div class="bar-wrapper">
                    <div class="bar bar-low" style="width: @GetPercentage(lowCount)%">
                        <span class="bar-text">@lowCount</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <button class="action-btn primary" @onclick="ViewAllIncidents">
            <span class="btn-icon"><i class="bi bi-clipboard-data"></i></span>
            <span>View All Incidents</span>
        </button>
        <button class="action-btn success" @onclick="ViewAllAlerts">
            <span class="btn-icon"><i class="bi bi-bell-fill"></i></span>
            <span>View All Alerts</span>
        </button>
    </div>

    <!-- Recent Incidents -->
    <div class="content-card">
        <div class="card-header">
            <h2>Recent Incidents</h2>
            <a href="/incidents" class="link-view-all">View All →</a>
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Description</th>
                    <th>Severity</th>
                    <th>Status</th>
                    <th>Created</th>
                </tr>
                </thead>
                <tbody>
                @if (recentIncidents == null){
                    <tr>
                        <td colspan="5" class="loading">Loading...</td>
                    </tr>
                }
                else if (!recentIncidents.Any()){
                    <tr>
                        <td colspan="5" class="no-data">No incidents</td>
                    </tr>
                }
                else{
                    @foreach (var incident in recentIncidents.Take(5)){
                        <tr class="table-row" @onclick="() => ViewIncident(incident.Id)">
                            <td class="incident-id">IN@incident.Id</td>
                            <td>@incident.Description</td>
                            <td>
                                    <span class="severity-badge severity-@incident.Severity.ToString().ToLower()">
                                        @incident.Severity
                                    </span>
                            </td>
                            <td>@incident.Status</td>
                            <td>@incident.CreatedAt.ToString("dd.MM.yyyy HH:mm")</td>
                        </tr>
                    }
                }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Recent Alerts -->
    <div class="content-card">
        <div class="card-header">
            <h2>Recent Alerts</h2>
            <a href="/alerts" class="link-view-all">View All →</a>
        </div>
        <div class="alerts-grid">
            @if (recentAlerts == null || !recentAlerts.Any()){
                <div class="no-data">No alerts</div>
            }
            else{
                @foreach (var alert in recentAlerts.Take(6)){
                    <div class="alert-card">
                        <div class="alert-header">
                            <span class="alert-id">@alert.AlertId</span>
                            <span class="severity-badge severity-@alert.Severity.ToLower()">
                                @alert.Severity
                            </span>
                        </div>
                        <div class="alert-body">
                            <p class="alert-description">@alert.Description</p>
                            <div class="alert-meta">
                                <span><i class="bi bi-pc-display"></i> @alert.Host</span>
                                <span><i class="bi bi-clock"></i> @alert.Timestamp.ToString("HH:mm")</span>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>

@code {
    private List<IncidentDto>? recentIncidents;
    private List<AlertDto>? recentAlerts;

    private int openIncidents = 0;
    private int newAlerts = 0;
    private int criticalCount = 0;
    private int highCount = 0;
    private int mediumCount = 0;
    private int lowCount = 0;
    private int resolvedToday = 0;
    private int totalIncidents = 0;

    protected override async Task OnInitializedAsync() {
        await LoadData();
    }

    private async Task LoadData() {
        try{
            recentIncidents = await Http.GetFromJsonAsync<List<IncidentDto>>("api/incidents");

            recentAlerts = new List<AlertDto> {
                new() { AlertId = "ALT001", Description = "Suspicious login attempt detected", Host = "web-server-01", Severity = "Critical", Timestamp = DateTime.Now.AddHours(-2) },
                new() { AlertId = "ALT002", Description = "High CPU usage detected", Host = "db-server-02", Severity = "High", Timestamp = DateTime.Now.AddHours(-1) },
                new() { AlertId = "ALT003", Description = "Disk space running low", Host = "api-gateway", Severity = "Medium", Timestamp = DateTime.Now.AddMinutes(-30) },
                new() { AlertId = "ALT004", Description = "Network latency increased", Host = "web-server-02", Severity = "Low", Timestamp = DateTime.Now.AddMinutes(-15) }
            };

            if (recentIncidents != null){
                totalIncidents = recentIncidents.Count;
                openIncidents = recentIncidents.Count(i => i.Status != IncidentStatus.Resolved);
                criticalCount = recentIncidents.Count(i => i.Severity == IncidentSeverity.Critical);
                highCount = recentIncidents.Count(i => i.Severity == IncidentSeverity.High);
                mediumCount = recentIncidents.Count(i => i.Severity == IncidentSeverity.Medium);
                lowCount = recentIncidents.Count(i => i.Severity == IncidentSeverity.Low);
                resolvedToday = recentIncidents.Count(i => i.ClosedAt?.Date == DateTime.Today);
            }

            newAlerts = recentAlerts?.Count ?? 0;
        }
        catch (Exception ex){
            Console.WriteLine($"Error loading data: {ex.Message}");
        }
    }

    private double GetPercentage(int count) {
        if (totalIncidents == 0) return 0;
        return Math.Max(10, (count * 100.0 / totalIncidents));
    }

    private void ViewIncident(int id) {
        Navigation.NavigateTo($"/incidents/{id}");
    }

    private void ViewAllIncidents() {
        Navigation.NavigateTo("/incidents");
    }

    private void ViewAllAlerts() {
        Navigation.NavigateTo("/alerts");
    }

    public class IncidentDto {
        public int Id { get; set; }
        public string Description { get; set; } = "";
        public DateTime CreatedAt { get; set; }
        public DateTime? ClosedAt { get; set; }
        public IncidentStatus Status { get; set; }
        public IncidentSeverity Severity { get; set; }
    }

    public class AlertDto {
        public string AlertId { get; set; } = "";
        public string Description { get; set; } = "";
        public string Host { get; set; } = "";
        public string Severity { get; set; } = "Low";
        public DateTime Timestamp { get; set; }
    }

    public enum IncidentStatus {
        New,
        Open,
        InProgress,
        Resolved,
        Escalated
    }

    public enum IncidentSeverity {
        Low,
        Medium,
        High,
        Critical
    }

}
