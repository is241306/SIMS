@page "/incidents/create"
@inject HttpClient Http
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Create Incident - SIMS</PageTitle>

<div class="page-wrapper">
    <div class="page-header">
        <h1><i class="bi bi-plus-circle"></i> Create New Incident</h1>
        <button class="btn-back" @onclick="GoBack"><i class="bi bi-arrow-left"></i> Back</button>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage)){
        <div class="alert alert-error">
            <i class="bi bi-exclamation-triangle-fill"></i> @errorMessage
        </div>
    }

    <div class="content-card">
        <form @onsubmit="CreateIncident">
            <div class="form-grid">
                <div class="form-group">
                    <label for="description">Description *</label>
                    <textarea id="description"
                              @bind="incident.Description"
                              rows="4"
                              class="form-input"
                              placeholder="Describe the incident..."
                              required></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="severity">Severity *</label>
                        <select id="severity" @bind="incident.Severity" class="form-input" required>
                            <option value="">Select Severity</option>
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="status">Status *</label>
                        <select id="status" @bind="incident.Status" class="form-input" required>
                            <option value="">Select Status</option>
                            <option value="New">New</option>
                            <option value="Open">Open</option>
                            <option value="InProgress">Investigating</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="assignedUser">Assign To</label>
                    <select id="assignedUser" @bind="incident.AssignedId" class="form-input">
                        <option value="0">Unassigned</option>
                        @foreach (var user in users){
                            <option value="@user.Id">@user.Name</option>
                        }
                    </select>
                </div>

                <div class="form-group">
                    <label for="alertId">Related Alert (Optional)</label>
                    <input id="alertId"
                           type="text"
                           @bind="incident.AlertId"
                           class="form-input"
                           placeholder="e.g., ALT001"/>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-create" disabled="@isSubmitting">
                    @if (isSubmitting){
                        <span><i class="bi bi-hourglass-split"></i> Creating...</span>
                    }
                    else{
                        <span><i class="bi bi-check2-circle"></i> Create Incident</span>
                    }
                </button>
                <button type="button" class="btn-cancel" @onclick="GoBack">Cancel</button>
            </div>
        </form>
    </div>

    <!-- Preview Card -->
    @if (!string.IsNullOrEmpty(incident.Description)){
        <div class="content-card preview-card">
            <h2><i class="bi bi-clipboard-data"></i> Preview</h2>
            <div class="preview-content">
                <div class="preview-item">
                    <span class="preview-label">Description:</span>
                    <span class="preview-value">@incident.Description</span>
                </div>
                <div class="preview-item">
                    <span class="preview-label">Severity:</span>
                    @if (!string.IsNullOrEmpty(incident.Severity)){
                        <span class="severity-badge severity-@incident.Severity.ToLower()">@incident.Severity</span>
                    }
                </div>
                <div class="preview-item">
                    <span class="preview-label">Status:</span>
                    @if (!string.IsNullOrEmpty(incident.Status)){
                        <span class="status-badge">@incident.Status</span>
                    }
                </div>
                @if (incident.AssignedId > 0){
                    <div class="preview-item">
                        <span class="preview-label">Assigned To:</span>
                        <span class="preview-value">@users.FirstOrDefault(u => u.Id == incident.AssignedId)?.Name</span>
                    </div>
                }
            </div>
        </div>
    }
</div>

<style>
    :root {
        --color-primary: #113B40;
        --color-success: #038C3E;
        --color-bg: #F2F2F2;
        --severity-critical: #E3342F;
        --severity-high: #3B82F6;
        --severity-medium: #FACC15;
        --severity-low: #9CA3AF;
    }

    .page-wrapper {
        padding: 2rem;
        max-width: 1000px;
        margin: 0 auto;
        background: var(--color-bg);
        min-height: 100vh;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .page-header h1 {
        color: var(--color-primary);
        font-size: 2rem;
        font-weight: 700;
    }

    .btn-back {
        padding: 0.75rem 1.5rem;
        background: #E5E7EB;
        color: #374151;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-back:hover {
        background: #D1D5DB;
        transform: translateY(-2px);
    }

    .alert {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }

    .alert-error {
        background: #FEE2E2;
        color: #E3342F;
        border: 1px solid #E3342F;
    }

    .content-card {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
    }

    .content-card h2 {
        color: var(--color-primary);
        margin-bottom: 1.5rem;
        font-size: 1.25rem;
    }

    .form-grid {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .form-group label {
        font-weight: 600;
        color: var(--color-primary);
        font-size: 0.875rem;
    }

    .form-input {
        padding: 0.75rem;
        border: 2px solid #E5E7EB;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(17, 59, 64, 0.1);
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 2px solid var(--color-bg);
    }

    .btn-create, .btn-cancel {
        padding: 1rem 2rem;
        border: none;
        border-radius: 8px;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-create {
        background: linear-gradient(135deg, var(--color-success) 0%, #41BF78 100%);
        color: white;
        flex: 1;
    }

    .btn-create:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(3, 140, 62, 0.3);
    }

    .btn-create:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .btn-cancel {
        background: #6B7280;
        color: white;
    }

    .btn-cancel:hover {
        background: #4B5563;
        transform: translateY(-2px);
    }

    /* Preview Card */
    .preview-card {
        background: linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%);
        border: 2px dashed var(--color-primary);
    }

    .preview-content {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .preview-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem;
        background: white;
        border-radius: 8px;
    }

    .preview-label {
        font-weight: 600;
        color: var(--color-primary);
        min-width: 120px;
    }

    .preview-value {
        color: #374151;
    }

    .severity-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
    }

    .severity-critical {
        background: #FEE2E2;
        color: var(--severity-critical);
    }

    .severity-high {
        background: #DBEAFE;
        color: var(--severity-high);
    }

    .severity-medium {
        background: #FEF3C7;
        color: #92400E;
    }

    .severity-low {
        background: #F3F4F6;
        color: var(--severity-low);
    }

    .status-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 700;
        background: #DBEAFE;
        color: #3B82F6;
    }

    @@media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }
    }
</style>

@code {
    private CreateIncidentDto incident = new();
    private List<UserDto> users = new();
    private string? errorMessage;
    private bool isSubmitting = false;

    protected override async Task OnInitializedAsync() {
        await LoadUsers();

        incident.Status = "New";
        incident.Severity = "Medium";
    }

    private async Task LoadUsers() {
        try{
            users = await Http.GetFromJsonAsync<List<UserDto>>("api/users") ?? new();
        }
        catch{
            users = new List<UserDto> {
                new() { Id = 1, Name = "John Doe" },
                new() { Id = 2, Name = "Jane Smith" },
                new() { Id = 3, Name = "Bob Johnson" }
            };
        }
    }

    private async Task CreateIncident() {
        if (string.IsNullOrWhiteSpace(incident.Description)){
            errorMessage = "Description is required";
            return;
        }

        if (string.IsNullOrEmpty(incident.Severity) || string.IsNullOrEmpty(incident.Status)){
            errorMessage = "Severity and Status are required";
            return;
        }

        isSubmitting = true;
        errorMessage = null;

        try{
            var response = await Http.PostAsJsonAsync("api/incidents", incident);

            if (response.IsSuccessStatusCode){
                var createdIncident = await response.Content.ReadFromJsonAsync<IncidentResponseDto>();
                if (createdIncident != null){
                    Navigation.NavigateTo($"/incidents/{createdIncident.Id}");
                }
                else{
                    Navigation.NavigateTo("/incidents");
                }
            }
            else{
                errorMessage = $"Failed to create incident: {response.StatusCode}";
            }
        }
        catch (Exception ex){
            errorMessage = $"Error creating incident: {ex.Message}";
        }
        finally{
            isSubmitting = false;
        }
    }

    private void GoBack() {
        Navigation.NavigateTo("/incidents");
    }

    public class CreateIncidentDto {
        public string Description { get; set; } = "";
        public string Severity { get; set; } = "";
        public string Status { get; set; } = "";
        public int AssignedId { get; set; }
        public string? AlertId { get; set; }
    }

    public class UserDto {
        public int Id { get; set; }
        public string Name { get; set; } = "";
    }

    public class IncidentResponseDto {
        public int Id { get; set; }
    }

}
