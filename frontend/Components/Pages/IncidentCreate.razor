@page "/incidents/create"
@inject HttpClient Http
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Create Incident - SIMS</PageTitle>

<div class="dashboard-wrapper incident-create-wrapper">
    <div class="page-header">
        <h1>
            <i class="bi bi-plus-circle"></i>
            <span>Create New Incident</span>
        </h1>

        <button class="btn-back" @onclick="GoBack">
            <i class="bi bi-arrow-left"></i>
            Back
        </button>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-error">
            <i class="bi bi-exclamation-triangle-fill"></i> @errorMessage
        </div>
    }

    <div class="content-card incident-form-card">
        <form @onsubmit="CreateIncident">
            <div class="form-grid">
                <div class="form-group">
                    <label for="description">Description *</label>
                    <textarea id="description"
                              @bind="incident.Description"
                              rows="4"
                              class="form-input"
                              placeholder="Describe the incident..."
                              required></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="severity">Severity *</label>
                        <select id="severity" @bind="incident.Severity" class="form-input" required>
                            <option value="">Select Severity</option>
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="status">Status *</label>
                        <select id="status" @bind="incident.Status" class="form-input" required>
                            <option value="">Select Status</option>
                            <option value="New">New</option>
                            <option value="Open">Open</option>
                            <option value="InProgress">Investigating</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="assignedUser">Assign To</label>
                    <select id="assignedUser" @bind="incident.AssignedId" class="form-input">
                        <option value="0">Unassigned</option>
                        @foreach (var user in users)
                        {
                            <option value="@user.Id">@user.Name</option>
                        }
                    </select>
                </div>

                <div class="form-group">
                    <label for="alertId">Related Alert (Optional)</label>
                    <input id="alertId"
                           type="text"
                           @bind="incident.AlertId"
                           class="form-input"
                           placeholder="e.g., ALT001" />
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-create" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <span><i class="bi bi-hourglass-split"></i> Creating...</span>
                    }
                    else
                    {
                        <span><i class="bi bi-check2-circle"></i> Create Incident</span>
                    }
                </button>

                <button type="button" class="btn-cancel" @onclick="GoBack">
                    Cancel
                </button>
            </div>
        </form>
    </div>

    @if (!string.IsNullOrEmpty(incident.Description))
    {
        <div class="content-card preview-card">
            <h2><i class="bi bi-clipboard-data"></i> Preview</h2>
            <div class="preview-content">
                <div class="preview-item">
                    <span class="preview-label">Description:</span>
                    <span class="preview-value">@incident.Description</span>
                </div>

                <div class="preview-item">
                    <span class="preview-label">Severity:</span>
                    @if (!string.IsNullOrEmpty(incident.Severity))
                    {
                        <span class="severity-badge severity-@incident.Severity.ToLower()">
                            @incident.Severity
                        </span>
                    }
                </div>

                <div class="preview-item">
                    <span class="preview-label">Status:</span>
                    @if (!string.IsNullOrEmpty(incident.Status))
                    {
                        <span class="status-badge">@incident.Status</span>
                    }
                </div>

                @if (incident.AssignedId > 0)
                {
                    <div class="preview-item">
                        <span class="preview-label">Assigned To:</span>
                        <span class="preview-value">
                            @users.FirstOrDefault(u => u.Id == incident.AssignedId)?.Name
                        </span>
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    private CreateIncidentDto incident = new();
    private List<UserDto> users = new();
    private string? errorMessage;
    private bool isSubmitting = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();

        incident.Status = "New";
        incident.Severity = "Medium";
    }

    private async Task LoadUsers()
    {
        try
        {
            users = await Http.GetFromJsonAsync<List<UserDto>>("api/users") ?? new();
        }
        catch
        {
            users = new List<UserDto> {
                new() { Id = 1, Name = "John Doe" },
                new() { Id = 2, Name = "Jane Smith" },
                new() { Id = 3, Name = "Bob Johnson" }
            };
        }
    }

    private async Task CreateIncident()
    {
        if (string.IsNullOrWhiteSpace(incident.Description))
        {
            errorMessage = "Description is required";
            return;
        }

        if (string.IsNullOrEmpty(incident.Severity) || string.IsNullOrEmpty(incident.Status))
        {
            errorMessage = "Severity and Status are required";
            return;
        }

        isSubmitting = true;
        errorMessage = null;

        try
        {
            var response = await Http.PostAsJsonAsync("api/incidents", incident);

            if (response.IsSuccessStatusCode)
            {
                var createdIncident = await response.Content.ReadFromJsonAsync<IncidentResponseDto>();
                if (createdIncident != null)
                {
                    Navigation.NavigateTo($"/incidents/{createdIncident.Id}");
                }
                else
                {
                    Navigation.NavigateTo("/incidents");
                }
            }
            else
            {
                errorMessage = $"Failed to create incident: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error creating incident: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/incidents");
    }

    public class CreateIncidentDto
    {
        public string Description { get; set; } = "";
        public string Severity { get; set; } = "";
        public string Status { get; set; } = "";
        public int AssignedId { get; set; }
        public string? AlertId { get; set; }
    }

    public class UserDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
    }

    public class IncidentResponseDto
    {
        public int Id { get; set; }
    }
}
