@page "/incidents/{Id:int}"
@page "/incidents/{Id:int}/edit"
@inject HttpClient Http
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Incident #@Id - SIMS</PageTitle>

<div class="dashboard-wrapper incident-detail-wrapper">
    @if (loading)
    {
        <div class="content-card state-card loading-card">
            <div class="state-icon">
                <i class="bi bi-hourglass-split"></i>
            </div>
            <p>Loading incident...</p>
        </div>
    }
    else if (incident == null)
    {
        <div class="content-card state-card error-card">
            <div class="state-icon error">
                <i class="bi bi-x-octagon-fill"></i>
            </div>
            <h2>Incident Not Found</h2>
            <p>The incident with ID @Id could not be found.</p>
            <button class="btn-primary" @onclick="GoBack">
                <i class="bi bi-arrow-left"></i>
                Go Back
            </button>
        </div>
    }
    else
    {
        <!-- Header -->
        <div class="content-card detail-header-card">
            <div class="detail-header">
                <div class="header-left">
                    <h1>Incident #@incident.Id</h1>
                    <div class="badges">
                        <span class="severity-badge severity-@incident.Severity.ToString().ToLower()">
                            @incident.Severity
                        </span>
                        <span class="status-badge status-@incident.Status.ToString().ToLower()">
                            @incident.Status
                        </span>
                    </div>
                </div>

                <div class="header-actions">
                    @if (!isEditing)
                    {
                        <button class="btn-edit" @onclick="ToggleEdit">
                            <i class="bi bi-pencil-square"></i>
                            Edit
                        </button>
                    }
                    else
                    {
                        <button class="btn-save" @onclick="SaveIncident">
                            <i class="bi bi-save"></i>
                            Save
                        </button>
                        <button class="btn-cancel" @onclick="CancelEdit">
                            <i class="bi bi-x-circle"></i>
                            Cancel
                        </button>
                    }

                    <button class="btn-back" @onclick="GoBack">
                        <i class="bi bi-arrow-left"></i>
                        Back
                    </button>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="detail-content">
            <!-- Info / Edit card -->
            <div class="content-card">
                <div class="card-header">
                    <h2>
                        <i class="bi bi-clipboard-data"></i>
                        <span>Details</span>
                    </h2>
                </div>

                @if (isEditing)
                {
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Description</label>
                            <textarea @bind="incident.Description" rows="4" class="form-input"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Severity</label>
                            <select @bind="incident.Severity" class="form-input">
                                <option value="@IncidentSeverity.Low">Low</option>
                                <option value="@IncidentSeverity.Medium">Medium</option>
                                <option value="@IncidentSeverity.High">High</option>
                                <option value="@IncidentSeverity.Critical">Critical</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Status</label>
                            <select @bind="incident.Status" class="form-input">
                                <option value="@IncidentStatus.New">New</option>
                                <option value="@IncidentStatus.Open">Open</option>
                                <option value="@IncidentStatus.InProgress">Investigating</option>
                                <option value="@IncidentStatus.Resolved">Resolved</option>
                                <option value="@IncidentStatus.Escalated">Escalated</option>
                            </select>
                        </div>
                    </div>
                }
                else
                {
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Description</span>
                            <span class="info-value">@incident.Description</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Created</span>
                            <span class="info-value">
                                @incident.CreatedAt.ToString("dd.MM.yyyy HH:mm")
                            </span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Updated</span>
                            <span class="info-value">
                                @incident.UpdatedAt.ToString("dd.MM.yyyy HH:mm")
                            </span>
                        </div>
                        @if (incident.ClosedAt.HasValue)
                        {
                            <div class="info-item">
                                <span class="info-label">Closed</span>
                                <span class="info-value">
                                    @incident.ClosedAt.Value.ToString("dd.MM.yyyy HH:mm")
                                </span>
                            </div>
                        }
                    </div>
                }
            </div>

            <!-- Timeline card -->
            <div class="content-card">
                <div class="card-header">
                    <h2>
                        <i class="bi bi-calendar-event"></i>
                        <span>Timeline</span>
                    </h2>
                </div>

                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-marker created"></div>
                        <div class="timeline-content">
                            <div class="timeline-title">Incident Created</div>
                            <div class="timeline-time">
                                @incident.CreatedAt.ToString("dd.MM.yyyy HH:mm")
                            </div>
                        </div>
                    </div>

                    @if (incident.Status == IncidentStatus.InProgress)
                    {
                        <div class="timeline-item">
                            <div class="timeline-marker progress"></div>
                            <div class="timeline-content">
                                <div class="timeline-title">Investigation Started</div>
                                <div class="timeline-time">
                                    @incident.UpdatedAt.ToString("dd.MM.yyyy HH:mm")
                                </div>
                            </div>
                        </div>
                    }

                    @if (incident.Status == IncidentStatus.Resolved && incident.ClosedAt.HasValue)
                    {
                        <div class="timeline-item">
                            <div class="timeline-marker resolved"></div>
                            <div class="timeline-content">
                                <div class="timeline-title">Incident Resolved</div>
                                <div class="timeline-time">
                                    @incident.ClosedAt.Value.ToString("dd.MM.yyyy HH:mm")
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public int Id { get; set; }

    private IncidentDto? incident;
    private bool loading = true;
    private bool isEditing = false;

    protected override async Task OnInitializedAsync() {
        await LoadIncident();
    }

    private async Task LoadIncident() {
        loading = true;
        try{
            incident = await Http.GetFromJsonAsync<IncidentDto>($"api/incidents/{Id}");
        }
        catch (Exception ex){
            Console.WriteLine($"Error loading incident: {ex.Message}");
        }
        finally{
            loading = false;
        }
    }

    private void ToggleEdit() {
        isEditing = true;
    }

    private void CancelEdit() {
        isEditing = false;
        LoadIncident();
    }

    private async Task SaveIncident() {
        try{
            await Http.PutAsJsonAsync($"api/incidents/{Id}", incident);
            isEditing = false;
            await LoadIncident();
        }
        catch (Exception ex){
            Console.WriteLine($"Error saving incident: {ex.Message}");
        }
    }

    private void GoBack() {
        Navigation.NavigateTo("/incidents");
    }

    public class IncidentDto {
        public int Id { get; set; }
        public string Description { get; set; } = "";
        public DateTime CreatedAt { get; set; }
        public DateTime UpdatedAt { get; set; }
        public DateTime? ClosedAt { get; set; }
        public IncidentStatus Status { get; set; }
        public IncidentSeverity Severity { get; set; }
    }

    public enum IncidentStatus {
        New,
        Open,
        InProgress,
        Resolved,
        Escalated
    }

    public enum IncidentSeverity {
        Low,
        Medium,
        High,
        Critical
    }

}
