@page "/incidents"
@inject HttpClient Http
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Incidents - SIMS</PageTitle>

<div class="dashboard-wrapper incidents-wrapper">
    <div class="page-header">
        <h1>
            <i class="bi bi-clipboard-data"></i>
            <span>Incidents Management</span>
        </h1>

        <button class="action-btn primary btn-create" @onclick="CreateIncident">
            <i class="bi bi-plus-circle"></i>
            <span>New Incident</span>
        </button>
    </div>

    <!-- Filters -->
    <div class="content-card filters-card">
        <div class="filters-inner">
            <div class="filter-group">
                <label>Status</label>
                <select @bind="filterStatus" @bind:event="onchange" class="filter-select">
                    <option value="">All</option>
                    <option value="New">New</option>
                    <option value="Open">Open</option>
                    <option value="InProgress">Investigating</option>
                    <option value="Resolved">Resolved</option>
                    <option value="Escalated">Escalated</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Severity</label>
                <select @bind="filterSeverity" @bind:event="onchange" class="filter-select">
                    <option value="">All</option>
                    <option value="Critical">Critical</option>
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                </select>
            </div>

            <div class="filters-actions">
                <button class="action-btn" @onclick="ResetFilters">
                    <i class="bi bi-arrow-counterclockwise"></i>
                    Reset
                </button>
            </div>
        </div>
    </div>

    <!-- Incidents Table -->
    <div class="content-card">
        <div class="card-header">
            <h2>Incidents</h2>
            <span class="badge-soft">
                @(filteredIncidents?.Count ?? 0) incident(s)
            </span>
        </div>

        <div class="table-container">
            <table class="data-table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Description</th>
                    <th>Severity</th>
                    <th>Status</th>
                    <th>Assigned To</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                @if (filteredIncidents == null)
                {
                <tr>
                    <td colspan="7" class="loading">Loading...</td>
                </tr>
                }
                else if (!filteredIncidents.Any())
                {
                <tr>
                    <td colspan="7" class="no-data">No incidents found</td>
                </tr>
                }
                else
                {
                @foreach (var incident in filteredIncidents)
                {
                <tr class="table-row">
                    <td class="incident-id" @onclick="() => ViewDetails(incident.Id)">
                        IN@incident.Id
                    </td>
                    <td @onclick="() => ViewDetails(incident.Id)">
                        @incident.Description
                    </td>
                    <td>
                                <span class="severity-badge severity-@incident.Severity.ToString().ToLower()">
                                    @incident.Severity
                                </span>
                    </td>
                    <td>
                        <select class="status-select status-@incident.Status.ToString().ToLower()"
                                value="@incident.Status"
                                @onchange="@(async (e) => await ChangeStatus(incident.Id, e.Value?.ToString() ?? string.Empty))">
                            <option value="New">New</option>
                            <option value="Open">Open</option>
                            <option value="InProgress">Investigating</option>
                            <option value="Resolved">Resolved</option>
                            <option value="Escalated">Escalated</option>
                        </select>
                    </td>
                    <td>
                        <select class="assign-select"
                                value="@(incident.AssignedId ?? 0)"
                                @onchange="@(async (e) => await AssignUser(incident.Id, int.Parse(e.Value?.ToString() ?? "0")))">
                            <option value="0">Unassigned</option>
                            @foreach (var user in users)
                            {
                            <option value="@user.Id">@user.Name</option>
                            }
                        </select>
                    </td>
                    <td>@incident.CreatedAt.ToString("dd.MM.yyyy HH:mm")</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon-action btn-view"
                                    @onclick="() => ViewDetails(incident.Id)"
                                    title="View Details">
                                <i class="bi bi-eye-fill"></i>
                            </button>
                            <button class="btn-icon-action btn-edit"
                                    @onclick="() => EditIncident(incident.Id)"
                                    title="Edit">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                }
                }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {
private List<IncidentDto>? incidents;
private List<IncidentDto>? filteredIncidents;
private List<UserDto> users = new();

private string _filterStatus = "";
private string filterStatus {
get => _filterStatus;
set {
_filterStatus = value;
ApplyFilters();
}
}

private string _filterSeverity = "";
private string filterSeverity {
get => _filterSeverity;
set {
_filterSeverity = value;
ApplyFilters();
}
}

protected override async Task OnInitializedAsync() {
await LoadData();
}

private async Task LoadData() {
try{
incidents = await Http.GetFromJsonAsync<List<IncidentDto>>("api/incidents");

users = new List<UserDto> {
new() { Id = 1, Name = "John Doe" },
new() { Id = 2, Name = "Jane Smith" },
new() { Id = 3, Name = "Bob Johnson" }
};

ApplyFilters();
}
catch (Exception ex){
Console.WriteLine($"Error: {ex.Message}");
}
}

private void ApplyFilters() {
filteredIncidents = incidents?.Where(i =>
(string.IsNullOrEmpty(filterStatus) || i.Status.ToString() == filterStatus) &&
(string.IsNullOrEmpty(filterSeverity) || i.Severity.ToString() == filterSeverity)
).ToList();
}

private void ResetFilters() {
filterStatus = "";
filterSeverity = "";
ApplyFilters();
}

private async Task ChangeStatus(int id, string newStatus) {
try{
await Http.PutAsync($"api/incidents/{id}/status?status={newStatus}", null);
await LoadData();
}
catch (Exception ex){
Console.WriteLine($"Error: {ex.Message}");
}
}

private async Task AssignUser(int incidentId, int userId) {
try{
await Http.PutAsync($"api/incidents/{incidentId}/assign?userId={userId}", null);
await LoadData();
}
catch (Exception ex){
Console.WriteLine($"Error: {ex.Message}");
}
}

private void ViewDetails(int id) {
Navigation.NavigateTo($"/incidents/{id}");
}

private void EditIncident(int id) {
Navigation.NavigateTo($"/incidents/{id}/edit");
}

private void CreateIncident() {
Navigation.NavigateTo("/incidents/create");
}

public class IncidentDto {
public int Id { get; set; }
public string Description { get; set; } = "";
public DateTime CreatedAt { get; set; }
public IncidentStatus Status { get; set; }
public IncidentSeverity Severity { get; set; }
public int? AssignedId { get; set; }
}

public class UserDto {
public int Id { get; set; }
public string Name { get; set; } = "";
}

public enum IncidentStatus {
New,
Open,
InProgress,
Resolved,
Escalated
}

public enum IncidentSeverity {
Low,
Medium,
High,
Critical
}

}
