@page "/Register"
@rendermode InteractiveServer
@using frontend.Components.Layout
@using System.Net.Http.Json
@using frontend.Models
@inject IHttpClientFactory HttpFactory
@layout EmptyLayout


<div class="center-wrapper">
    <div class="register-container">
        <div class="content-image">
            <img id="login_img" src="/img/login.png" alt="Register"/>
        </div>
        <div class="content-text">
            <div class="form-text">
                <h3>Create your account</h3>
                <h6>Join your SIMS and manage your service with ease.</h6>

                <div class="form-group">
                    <label for="name">Name</label>
                    <input id="name" type="text" @bind="_model.Username"/>
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input id="password" type="password" @bind="_model.Password"/>
                </div>

                <button class="btn-primary-full" type="button" @onclick="HandleRegister" disabled="@_loading">
                    Create account
                </button>

                @if (!string.IsNullOrEmpty(_error)){
                    <div style="color: red; margin-top: 10px;">@_error</div>
                }

                @if (_success){
                    <div style="color: green; margin-top: 10px;">
                        Account created! <a href="/login">Log in</a>
                    </div>
                }

                <div class="login-text">
                    Have an account? <a href="/login">Log in</a>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private RegisterModel _model = new();
    private string? _error;
    private bool _success;
    private bool _loading;

    private HttpClient ApiClient => HttpFactory.CreateClient("api");

    private async Task HandleRegister() {
        _error = null;
        _success = false;
        _loading = true;

        try{
            var response = await ApiClient.PostAsJsonAsync("api/auth/register", _model);

            if (response.IsSuccessStatusCode){
                _success = true;
            }
            else{
                var msg = await response.Content.ReadAsStringAsync();
                _error = string.IsNullOrWhiteSpace(msg)
                    ? "Registration failed."
                    : msg;
            }
        }
        catch (Exception e){
            _error = $"Error: {e.Message}";
        }
        finally{
            _loading = false;
        }
    }

    public class RegisterModel {
        public string Username { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }

}